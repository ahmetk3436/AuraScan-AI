<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>

# Fully Autonomous Mobile System — Master Reference

## What Is This Project?

An **autonomous app factory** that generates, tests, deploys, and self-heals full-stack mobile applications. The system takes a task list and autonomously builds iOS-compliant apps with zero human intervention.

**Proven Output**: EcoMonitor AI — built, deployed, and running at `http://89.47.113.196:8081/api/health` with all 5 tasks completed on first attempt.

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────┐
│                    ORCHESTRATOR (Go)                     │
│  ┌──────────┐  ┌─────────────┐  ┌──────────┐          │
│  │  Engine   │  │ Executioner │  │ Debugger │          │
│  │(GLM-4/DS)│  │ (API/CLI)   │  │(GLM-4/DS)│          │
│  └────┬─────┘  └──────┬──────┘  └────┬─────┘          │
│       │               │               │                 │
│       ▼               ▼               ▼                 │
│  ┌──────────────────────────────────────────┐          │
│  │   Autonomous Loop: Plan→Execute→Test→Fix  │          │
│  └──────────────────────────────────────────┘          │
│       │                                                 │
│       ▼                                                 │
│  ┌─────────────────────┐                               │
│  │   Git-Claw: Deploy   │                               │
│  │  git→github→coolify  │                               │
│  └─────────────────────┘                               │
└─────────────────────────────────────────────────────────┘
         │                        │
         ▼                        ▼
┌─────────────────┐    ┌──────────────────┐
│  BACKEND (Go)   │    │  MOBILE (Expo)   │
│  Fiber + GORM   │    │  RN + NativeWind │
│  PostgreSQL     │    │  Expo Router v6  │
└─────────────────┘    └──────────────────┘
```

## Directory Structure

```
fully-autonomous-mobile-system/
├── backend/                 # Go-Fiber v2 + GORM + PostgreSQL
│   ├── cmd/server/main.go   # Entry point
│   ├── internal/
│   │   ├── config/          # Env var loading
│   │   ├── database/        # GORM + AutoMigrate
│   │   ├── dto/             # Request/response types
│   │   ├── handlers/        # HTTP handlers (auth, health, moderation, webhook)
│   │   ├── middleware/      # JWT auth, CORS
│   │   ├── models/          # User, RefreshToken, Subscription, Report, Block
│   │   ├── routes/          # Route registration
│   │   └── services/        # Business logic (auth, moderation, subscription)
│   ├── Dockerfile           # Multi-stage build (golang:1.25-alpine)
│   ├── go.mod               # Module: github.com/ahmetcoskunkizilkaya/fully-autonomous-mobile-system/backend
│   └── .air.toml            # Hot reload config
│
├── mobile/                  # Expo SDK 54 + React Native 0.81 + NativeWind v4
│   ├── app/                 # Expo Router pages
│   │   ├── _layout.tsx      # Root: AuthProvider + StatusBar
│   │   ├── index.tsx        # Redirect based on auth state
│   │   ├── (auth)/          # Login, Register screens
│   │   └── (protected)/     # Tabs: Home, Settings (+ new tabs via orchestrator)
│   ├── components/ui/       # Button, Input, Modal, AppleSignIn, Report, Block
│   ├── contexts/            # AuthContext (token management)
│   ├── lib/                 # api.ts, haptics.ts, biometrics.ts, storage.ts, cn.ts
│   ├── types/               # TypeScript interfaces
│   └── package.json         # Expo 54, React 19.1, RN 0.81.5
│
├── orchestrator/            # Autonomous LLM agent system
│   ├── cmd/orchestrator/    # main.go (flags: -mode, -task)
│   ├── internal/
│   │   ├── agents/          # Engine, Executioner, Debugger + types
│   │   ├── config/          # Agent config from env vars
│   │   ├── loop/            # Autonomous loop (Plan→Execute→Test→Correct)
│   │   ├── project/         # Project discovery (finds backend/, mobile/, etc.)
│   │   └── task/            # Task manager (reads/writes task_list.json)
│   └── go.mod
│
├── deploy/                  # Docker Compose + Coolify scripts
│   ├── docker-compose.yml   # postgres + backend services
│   └── coolify-deploy.sh    # REST API deployment trigger
│
├── docs/                    # Reviewer notes, requirements template
├── task_list.json           # Orchestrator task input
├── .env.example             # All env vars documented
├── .env                     # NEVER committed (in .gitignore)
└── .gitignore
```

---

## Orchestrator — How It Works

### Agents

| Agent | Role | Backend | Config |
|-------|------|---------|--------|
| **Engine** | Generates implementation plans | DeepSeek/GLM-4 API | `ENGINE_API_KEY`, `ENGINE_API_URL`, `ENGINE_MODEL` |
| **Executioner** | Writes code (creates/modifies files) | **Configurable**: `api` mode (GLM-4.7 API) or `cli` mode (Claude -p) | `EXECUTIONER_MODE`, `EXECUTIONER_API_KEY`, `EXECUTIONER_API_URL`, `EXECUTIONER_MODEL` |
| **Debugger** | Analyzes test failures, suggests fixes | DeepSeek/GLM-4 API | `DEBUGGER_API_KEY`, `DEBUGGER_API_URL`, `DEBUGGER_MODEL` |

### Autonomous Loop

```
for each task in task_list.json:
  1. PLAN    — Engine generates step-by-step implementation plan
  2. EXECUTE — Executioner implements the plan (writes files)
  3. TEST    — Run test command (e.g., `cd backend && go build ./...`)
     ├── PASS → Mark task completed, next task
     └── FAIL → Go to step 4
  4. CORRECT — Debugger analyzes error, generates fix
  5. APPLY   — Executioner applies the fix
  6. GOTO 3  — Retry (max 5 attempts)
```

### Executioner Modes

**API Mode** (`EXECUTIONER_MODE=api`) — Default, cost-effective:
- Uses GLM-4.7 or any OpenAI-compatible API
- Receives the plan, generates file contents as structured output
- The orchestrator parses the response and writes files to disk
- Config: `EXECUTIONER_API_KEY`, `EXECUTIONER_API_URL`, `EXECUTIONER_MODEL`

**CLI Mode** (`EXECUTIONER_MODE=cli`) — High quality, expensive:
- Spawns `claude -p --dangerously-skip-permissions "<prompt>"`
- Claude Code reads existing codebase and writes files directly
- Timeout: 600 seconds (configurable via `EXECUTIONER_TIMEOUT`)
- Requires Claude Code CLI installed

### Task List Format (`task_list.json`)

```json
{
  "tasks": [
    {
      "id": "task_001",
      "title": "Short task name",
      "description": "Detailed description with file paths and expected behavior",
      "status": "pending|in_progress|completed|failed",
      "priority": 9,
      "depends_on": ["task_000"],
      "test_command": "cd backend && go build ./...",
      "auto_commit": true,
      "created_at": "2026-02-05T00:00:00Z",
      "updated_at": "2026-02-05T00:00:00Z",
      "attempts": 1,
      "duration": "2m30s"
    }
  ]
}
```

### New Features (v0.3.0)

1. **Per-task test command**: Each task can specify its own `test_command` that overrides the global default
2. **Auto-commit (Git-Claw)**: Set `auto_commit: true` on a task or `AUTO_COMMIT=true` globally to auto-commit after successful tests
3. **Detailed logging**: Set `LOG_DIR=./logs` to save detailed execution logs per task
4. **Codebase context**: API mode now reads existing project structure to maintain consistency
5. **Execution metrics**: Tasks track `attempts` count and `duration` for analysis

### Running the Orchestrator

```bash
cd orchestrator

# Set env vars (or source .env)
export ENGINE_API_KEY="your-deepseek-or-glm-key"
export EXECUTIONER_MODE="api"
export EXECUTIONER_API_KEY="your-glm4-key"
export EXECUTIONER_API_URL="https://open.bigmodel.cn/api/paas/v4/chat/completions"
export EXECUTIONER_MODEL="glm-4-0520"

# Build
go build -o orchestrator_bin ./cmd/orchestrator/

# Run all pending tasks
./orchestrator_bin -mode continuous

# Run a single task
./orchestrator_bin -mode single -task task_002
```

---

## Backend API Endpoints

### Public
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/health` | Health + DB status |
| POST | `/api/auth/register` | Email/password signup |
| POST | `/api/auth/login` | Email/password login |
| POST | `/api/auth/refresh` | Refresh access token |
| POST | `/api/auth/apple` | Sign in with Apple |

### Protected (JWT Required)
| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/auth/logout` | Sign out |
| DELETE | `/api/auth/account` | Delete account (Guideline 5.1.1) |
| POST | `/api/reports` | Report content (Guideline 1.2) |
| POST | `/api/blocks` | Block user |
| DELETE | `/api/blocks/:id` | Unblock user |

### Admin
| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/admin/moderation/reports` | List reports |
| PUT | `/api/admin/moderation/reports/:id` | Action report |

### Webhooks
| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/webhooks/revenuecat` | Subscription events |

---

## Apple App Store Compliance (Built-In)

| Guideline | Feature | Backend | Frontend |
|-----------|---------|---------|----------|
| **4.8** | Sign in with Apple | `POST /api/auth/apple` | `AppleSignInButton.tsx` |
| **5.1.1** | Account Deletion | `DELETE /api/auth/account` | Settings screen + password modal |
| **1.2** | UGC Safety | Report + Block models/endpoints | `ReportButton.tsx`, `BlockButton.tsx` |
| **1.2** | Admin Moderation | `GET/PUT /api/admin/moderation/reports` | — |
| **4.2** | Haptic Feedback | — | `lib/haptics.ts` (success/error/warning/selection) |
| **4.2** | Biometrics | — | `lib/biometrics.ts` (Face ID/Touch ID) |
| **3.1** | Restore Purchases | — | Settings screen button |

---

## Key Patterns & Conventions

### Backend (Go)
- **Module path**: `github.com/ahmetcoskunkizilkaya/fully-autonomous-mobile-system/backend`
- **Service pattern**: `NewXxxService(db *gorm.DB)` returns service struct
- **Handler pattern**: `NewXxxHandler(service)` returns handler struct
- **UUID primary keys**: `gorm:"type:uuid;default:gen_random_uuid();primaryKey"`
- **Soft delete**: All models use `gorm.DeletedAt`
- **JWT claims**: `sub` (user ID), `email`, `iat`, `exp`
- **Error response**: `{"error": true, "message": "..."}`

### Mobile (TypeScript/React Native)
- **Routing**: File-based with Expo Router v6 (`app/` directory)
- **Auth guard**: `(protected)/_layout.tsx` checks `isAuthenticated`
- **Styling**: NativeWind v4 (`className="..."`) + `cn()` utility
- **State**: React Context (AuthContext, SubscriptionContext)
- **Storage**: `expo-secure-store` for tokens
- **API client**: Axios with refresh queue interceptor (`lib/api.ts`)
- **Haptics**: Call `hapticSuccess()`, `hapticError()`, etc. on all user actions
- **Install command**: `npm install --legacy-peer-deps` (NativeWind peer dep conflicts)

### Orchestrator (Go)
- **Module path**: `github.com/ahmetcoskunkizilkaya/fully-autonomous-mobile-system/orchestrator`
- **Test command**: Must include `cd <subdir>` prefix (runs from PROJECT_ROOT)
- **Timeout**: Executioner 600s, Engine/Debugger 120s
- **Task dependencies**: Higher priority + all `depends_on` completed = picked next

---

## Coolify Deployment

### Key Facts
- **Server**: `http://89.47.113.196:8000` (Coolify dashboard)
- **API Auth**: `Bearer 1|gLNvAM35...` token
- **Server UUID**: `lgs0s8kkggk0c88ogws0wk44`
- **Project UUID**: `hwcw4gw0scs40888okkcs8ws` ("Prod ortam")
- **Environment**: `production` (UUID: `cgskc4o4ogc0gs84840os4kg`)

### API Gotchas
- `git_repository` format: `owner/repo` (NOT full URL — Coolify prepends `https://github.com/`)
- `ports_exposes` is **required** when creating apps
- Port 8080 often conflicts — use 8081+ for `ports_mappings`
- `base_directory: /backend` + `dockerfile_location: /Dockerfile` for monorepo
- Don't send `is_build_time` in env var API calls — Coolify v4 rejects it (422)
- Private repos need public access or GitHub App (Coolify strips PAT from URLs)
- DB internal hostname = database UUID (e.g., `to0o48co4occowcsccscwws4`)
- Dockerfile Go version MUST match `go.mod` (`golang:1.25-alpine` for `go 1.25.3`)

### Deployment Flow
```bash
# 1. Create PostgreSQL database
POST /api/v1/databases/postgresql
  → Returns internal_db_url with UUID hostname

# 2. Start database
POST /api/v1/databases/{db_uuid}/start

# 3. Create application
POST /api/v1/applications/public
  → git_repository: "owner/repo", base_directory: "/backend"

# 4. Add env vars (DB_HOST = database UUID)
POST /api/v1/applications/{app_uuid}/envs

# 5. Deploy
POST /api/v1/deploy  → body: {"uuid": "app_uuid", "force": true}

# 6. Monitor
GET /api/v1/deployments/{deployment_uuid}
```

---

## Generated Projects

### EcoMonitor AI (Feb 5, 2026)
- **Repo**: `github.com/ahmetk3436/EcoMonitor-AI` (private)
- **Live**: `http://89.47.113.196:8081/api/health`
- **Coolify App UUID**: `u4ksccssw8ow4cogckkwgk8c`
- **Coolify DB UUID**: `to0o48co4occowcsccscwws4`
- **Features**: GPS coordinates, satellite change detection (placeholder), map UI, alerts, RevenueCat paywall
- **Stats**: 5 tasks, all passed on first attempt, ~22 minutes total autonomous build

---

## Development Commands

```bash
# Backend
cd backend && go build ./...              # Compile check
cd backend && go test ./...               # Run tests
cd backend && air                          # Hot reload dev server

# Mobile
cd mobile && npm install --legacy-peer-deps   # Install deps
cd mobile && npx expo start                    # Dev server
cd mobile && npx tsc --noEmit                  # Type check

# Orchestrator
cd orchestrator && go build -o orchestrator_bin ./cmd/orchestrator/
cd orchestrator && ./orchestrator_bin -mode continuous

# Deploy (local)
cd deploy && docker compose up -d

# Deploy (Coolify)
cd deploy && ./coolify-deploy.sh
```

---

## Environment Variables Reference

See `.env.example` for all variables. Critical ones:

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `DB_HOST` | Yes | localhost | PostgreSQL host |
| `DB_PASSWORD` | Yes | — | PostgreSQL password |
| `JWT_SECRET` | Yes | — | Min 32 chars |
| `ENGINE_API_KEY` | Yes (orchestrator) | — | LLM API key for planning |
| `EXECUTIONER_MODE` | No | api | `api` or `cli` |
| `EXECUTIONER_API_KEY` | If mode=api | — | LLM API key for code gen |
| `EXECUTIONER_MODEL` | If mode=api | glm-4-0520 | Model name |
| `COOLIFY_TOKEN` | For deploy | — | Coolify API bearer token |
| `GITHUB_PAT` | For Git-Claw | — | GitHub personal access token |
